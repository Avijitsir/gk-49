const questions = [
    
  {
    "question": "আপেক্ষিকতাবাদ তত্ত্ব (Theory of Relativity) -এর প্রবর্তক কে?",
    "options": ["আইজ্যাক নিউটন", "আলবার্ট আইনস্টাইন", "গ্যালিলিও গ্যালিলি", "মেরি কুরি"],
    "answer": "আলবার্ট আইনস্টাইন",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "পেনিসিলিন কে আবিষ্কার করেন?",
    "options": ["লুই পাস্তুর", "রবার্ট কচ", "আলেকজান্ডার ফ্লেমিং", "এডওয়ার্ড জেনার"],
    "answer": "আলেকজান্ডার ফ্লেমিং",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "মহাকর্ষ সূত্র (Law of Gravitation) কে আবিষ্কার করেন?",
    "options": ["আইজ্যাক নিউটন", "কেপলার", "কোপার্নিকাস", "মাইকেল ফ্যারাডে"],
    "answer": "আইজ্যাক নিউটন",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "তেজস্ক্রিয়তা (Radioactivity) কে আবিষ্কার করেন?",
    "options": ["মেরি কুরি", "পিয়েরে কুরি", "হেনরি বেকেরেল", "আলবার্ট আইনস্টাইন"],
    "answer": "হেনরি বেকেরেল",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "এক্স-রে (X-ray) কে আবিষ্কার করেন?",
    "options": ["উইলহেলম রন্টজেন", "জে. জে. থমসন", "রাদারফোর্ড", "ম্যাক্স প্লাঙ্ক"],
    "answer": "উইলহেলম রন্টজেন",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "পশ্চিমবঙ্গের রাজধানী কী?",
    "options": ["দার্জিলিং", "কলকাতা", "আসানসোল", "শিলিগুড়ি"],
    "answer": "কলকাতা",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "বিহার রাজ্যের রাজধানী কী?",
    "options": ["গয়া", "মুজাফফরপুর", "পাটনা", "ভাগলপুর"],
    "answer": "পাটনা",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "আসাম রাজ্যের রাজধানী কী?",
    "options": ["গুয়াহাটি", "শিলচর", "ডিব্রুগড়", "দিসপুর"],
    "answer": "দিসপুর",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "গুজরাট রাজ্যের রাজধানী কী?",
    "options": ["আহমেদাবাদ", "সুরাট", "গান্ধীনগর", "ভাদোদরা"],
    "answer": "গান্ধীনগর",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "কেরালা রাজ্যের রাজধানী কী?",
    "options": ["কোচি", "থিরুভানানথাপুরাম", "কোঝিকোড়", "ত্রিশূর"],
    "answer": "থিরুভানানথাপুরাম",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "ভারতের জাতীয় কংগ্রেসের প্রথম অধিবেশন কোথায় অনুষ্ঠিত হয়?",
    "options": ["কলকাতা", "মুম্বাই", "দিল্লি", "চেন্নাই"],
    "answer": "মুম্বাই",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "কোন কংগ্রেস অধিবেশনে 'পূর্ণ স্বরাজ'-এর দাবি তোলা হয় (1929)?",
    "options": ["কলকাতা", "লাহোর", "সুরাট", "মুম্বাই"],
    "answer": "লাহোর",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "ভারতের জাতীয় কংগ্রেসের প্রথম মহিলা সভাপতি কে ছিলেন?",
    "options": ["সরোজিনী নাইডু", "অ্যানি বেসান্ত", "ইন্দিরা গান্ধী", "নেল্লি সেনগুপ্তা"],
    "answer": "অ্যানি বেসান্ত",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "কংগ্রেসের কোন অধিবেশনে নরমপন্থী ও চরমপন্থীদের মধ্যে বিভাজন হয় (1907)?",
    "options": ["সুরাট", "কলকাতা", "নাগপুর", "লাহোর"],
    "answer": "সুরাট",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "মহাত্মা গান্ধী কংগ্রেসের কোন অধিবেশনে (একমাত্র) সভাপতিত্ব করেন (1924)?",
    "options": ["গয়া", "বেলগাঁও", "কানপুর", "গুয়াহাটি"],
    "answer": "বেলগাঁও",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "ভারতের শেষ আদমশুমারি (Census) কত সালে অনুষ্ঠিত হয়েছিল?",
    "options": ["2001", "2011", "2015", "2021"],
    "answer": "2011",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "2011 সালের আদমশুমারি অনুযায়ী, ভারতের সর্বাধিক জনবহুল রাজ্য কোনটি?",
    "options": ["মহারাষ্ট্র", "বিহার", "উত্তরপ্রদেশ", "পশ্চিমবঙ্গ"],
    "answer": "উত্তরপ্রদেশ",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "2011 সালের আদমশুমারি অনুযায়ী, ভারতের কোন রাজ্যের সাক্ষরতার হার সর্বাধিক?",
    "options": ["কেরালা", "মিজোরাম", "গোয়া", "পশ্চিমবঙ্গ"],
    "answer": "কেরালা",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "2011 সালের আদমশুমারি অনুযায়ী, ভারতের সর্বনিম্ন জনঘনত্বপূর্ণ রাজ্য কোনটি?",
    "options": ["সিকিম", "মিজোরাম", "অরুণাচল প্রদেশ", "নাগাল্যান্ড"],
    "answer": "অরুণাচল প্রদেশ",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "ভারতে কত বছর অন্তর আদমশুমারি করা হয়?",
    "options": ["5 বছর", "8 বছর", "10 বছর", "12 বছর"],
    "answer": "10 বছর",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "মার্কিন যুক্তরাষ্ট্রের (USA) জাতীয় খেলা কী?",
    "options": ["বেসবল", "বাস্কেটবল", "আমেরিকান ফুটবল", "আইস হকি"],
    "answer": "বেসবল",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "স্পেনের জাতীয় খেলা কী?",
    "options": ["ফুটবল", "ষাঁড়ের লড়াই", "বাস্কেটবল", "টেনিস"],
    "answer": "ষাঁড়ের লড়াই",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "জাপানের জাতীয় খেলা কী?",
    "options": ["জুডো", "কারাতে", "সুমো কুস্তি", "বেসবল"],
    "answer": "সুমো কুস্তি",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "কানাডার জাতীয় (গ্রীষ্মকালীন) খেলা কী?",
    "options": ["আইস হকি", "ল্যাক্রোস", "কার্লিং", "বেসবল"],
    "answer": "ল্যাক্রোস",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "ভারতের জাতীয় খেলা কোনটি (ঐতিহ্যগতভাবে বিবেচিত)?",
    "options": ["ক্রিকেট", "কাবাডি", "হকি", "ফুটবল"],
    "answer": "হকি",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "আধুনিক অলিম্পিক গেমস কত সালে শুরু হয়?",
    "options": ["1890", "1896", "1900", "1904"],
    "answer": "1896",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "অলিম্পিক পতাকায় কয়টি রিং (Ring) থাকে?",
    "options": ["4", "5", "6", "7"],
    "answer": "5",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "কত বছর অন্তর গ্রীষ্মকালীন অলিম্পিক অনুষ্ঠিত হয়?",
    "options": ["2 বছর", "3 বছর", "4 বছর", "5 বছর"],
    "answer": "4 বছর",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "অলিম্পিকে ব্যক্তিগত ইভেন্টে সোনাজয়ী প্রথম ভারতীয় কে?",
    "options": ["নীরজ চোপড়া", "অভিনব বিন্দ্রা", "লিয়েন্ডার পেজ", "রাজ্যবর্ধন সিং রাঠোর"],
    "answer": "অভিনব বিন্দ্রা",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "2024 সালের গ্রীষ্মকালীন অলিম্পিক কোথায় অনুষ্ঠিত হয়েছে?",
    "options": ["লন্ডন", "টোকিও", "প্যারিস", "লস অ্যাঞ্জেলেস"],
    "answer": "প্যারিস",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "কোন সংবিধান সংশোধনীকে 'ক্ষুদ্র সংবিধান' (Mini-Constitution) বলা হয়?",
    "options": ["42nd", "44th", "1st", "73rd"],
    "answer": "42nd",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "কোন সংবিধান সংশোধনীতে ভোটাধিকারের বয়স 21 থেকে কমিয়ে 18 করা হয়?",
    "options": ["42nd", "44th", "61st", "73rd"],
    "answer": "61st",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "সম্পত্তির অধিকারকে (Right to Property) মৌলিক অধিকার থেকে বাদ দেওয়া হয় কোন সংশোধনীতে?",
    "options": ["42nd", "44th", "52nd", "61st"],
    "answer": "44th",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "পঞ্চায়েতি রাজ ব্যবস্থা কোন সংশোধনীর মাধ্যমে সাংবিধানিক মর্যাদা পায়?",
    "options": ["71st", "72nd", "73rd", "74th"],
    "answer": "73rd",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "GST (Goods and Services Tax) কোন সংবিধান সংশোধনীর মাধ্যমে চালু হয়?",
    "options": ["100th", "101st", "102nd", "99th"],
    "answer": "101st",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "ভারতের প্রথম পঞ্চবার্ষিকী পরিকল্পনা কত সালে শুরু হয়?",
    "options": ["1947", "1950", "1951", "1952"],
    "answer": "1951",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "কোন পঞ্চবার্ষিকী পরিকল্পনায় 'গরিবি হটাও' স্লোগান দেওয়া হয়েছিল?",
    "options": ["তৃতীয়", "চতুর্থ", "পঞ্চম", "ষষ্ঠ"],
    "answer": "পঞ্চম",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "দ্বিতীয় পঞ্চবার্ষিকী পরিকল্পনা কোন মডেলের উপর ভিত্তি করে তৈরি?",
    "options": ["হেরড-ডোমার মডেল", "মহলানবীশ মডেল", "নেহেরু মডেল", "গাডগিল মডেল"],
    "answer": "মহলানবীশ মডেল",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "'প্ল্যানিং কমিশন' (Planning Commission) -এর পরিবর্তে কোন সংস্থাটি গঠন করা হয়েছে?",
    "options": ["NITI Aayog", "Finance Commission", "National Development Council", "Lokpal"],
    "answer": "NITI Aayog",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "ভারতে 'প্ল্যান হলিডে' (Plan Holiday) কোন সময়কালে ছিল?",
    "options": ["1960-63", "1966-69", "1970-73", "1955-58"],
    "answer": "1966-69",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "মানবদেহের বৃহত্তম অঙ্গ (Organ) কোনটি?",
    "options": ["যকৃৎ (Liver)", "ত্বক (Skin)", "মস্তিষ্ক (Brain)", "ফুসফুস (Lungs)"],
    "answer": "ত্বক (Skin)",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "মানবদেহের 'মাস্টার গ্ল্যান্ড' (Master Gland) কাকে বলা হয়?",
    "options": ["থাইরয়েড", "পিটুইটারি", "অ্যাড্রিনাল", "অগ্ন্যাশয়"],
    "answer": "পিটুইটারি",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "একজন পূর্ণবয়স্ক মানুষের দেহে মোট হাড়ের সংখ্যা কত?",
    "options": ["200", "206", "210", "212"],
    "answer": "206",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "রক্ত পরিশোধনে (Blood Filtration) কোন অঙ্গটি কাজ করে?",
    "options": ["ফুসফুস", "যকৃৎ", "বৃক্ক (Kidney)", "পাকস্থলী"],
    "answer": "বৃক্ক (Kidney)",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "ইনসুলিন কোন গ্রন্থি থেকে নিঃসৃত হয়?",
    "options": ["অগ্ন্যাশয় (Pancreas)", "পিটুইটারি", "থাইরয়েড", "যকৃৎ"],
    "answer": "অগ্ন্যাশয় (Pancreas)",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "কলিঙ্গের যুদ্ধ (Kalinga War) কত সালে হয়েছিল?",
    "options": ["261 BC", "326 BC", "1526 AD", "1757 AD"],
    "answer": "261 BC",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "পলাশীর যুদ্ধ (Battle of Plassey) কত সালে হয়েছিল?",
    "options": ["1757", "1761", "1764", "1857"],
    "answer": "1757",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "পানিপথের প্রথম যুদ্ধ (First Battle of Panipat) কত সালে হয়েছিল?",
    "options": ["1526", "1556", "1761", "1576"],
    "answer": "1526",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "বক্সারের যুদ্ধ (Battle of Buxar) কত সালে হয়েছিল?",
    "options": ["1757", "1760", "1764", "1772"],
    "answer": "1764",
    "userAnswer": null,
    "status": null
  },
  {
    "question": "হলদিঘাটের যুদ্ধ (Battle of Haldighati) কাদের মধ্যে হয়েছিল?",
    "options": ["আকবর ও রানা প্রতাপ", "বাবর ও ইব্রাহিম লোদি", "সিরাজউদ্দৌলা ও ইংরেজ", "টিপু সুলতান ও ইংরেজ"],
    "answer": "আকবর ও রানা প্রতাপ",
    "userAnswer": null,
    "status": null
  }
];


let currentQuestionIndex = 0;
let score = 0;
let correctCount = 0;
let wrongCount = 0;
let skippedCount = 0;
let selectedOption = null;
let questionTimerInterval;
const questionTimeLimit = 30;
let questionTimeLeft;
let userName = ''; // ব্যবহারকারীর নাম সংরক্ষণের জন্য ভেরিয়েবল
const passMarkPercentage = 60; // Changed to 60%

// DOM Elements
const splashScreen = document.getElementById('splashScreen'); // নতুন স্প্ল্যাশ স্ক্রিন
const nameInputScreen = document.getElementById('nameInputScreen');
const userNameInput = document.getElementById('userNameInput');
const proceedToStartScreenButton = document.getElementById('proceedToStartScreenButton');
const nameInputMessage = document.getElementById('nameInputMessage');

const startScreen = document.getElementById('startScreen');
const startButton = document.getElementById('startButton');

const totalQuestionsInfo = document.getElementById('totalQuestionsInfo');
const fullMarksInfo = document.getElementById('fullMarksInfo');
const timeLimitInfo = document.getElementById('timeLimitInfo');

const quizScreen = document.getElementById('quizScreen');
const resultScreen = document.getElementById('resultScreen');

// New: References to the result summary and detailed answers containers
const resultSummary = document.getElementById('resultSummary');
const detailedAnswersContainer = document.getElementById('detailedAnswersContainer');


const scoreDisplayElem = document.getElementById('scoreDisplay');
const questionIndexDisplayElem = document.getElementById('questionIndexDisplay');

const questionTextBox = document.getElementById('questionTextBox');
const optionsContainer = document.getElementById('optionsContainer');
const feedbackMessage = document.getElementById('feedbackMessage');
const nextButton = document.getElementById('nextButton');
const skipButton = document.getElementById('skipButton');
const submitButton = document.getElementById('submitButton');

const questionTimerTextElem = document.getElementById('questionTimer');
const progressRingBar = document.querySelector('.progress-ring-bar');
const circumference = 2 * Math.PI * 35;
progressRingBar.style.strokeDasharray = circumference;
progressRingBar.style.strokeDashoffset = circumference;

const rankListElem = document.getElementById('rankList');

// New: Get the new buttons for detailed answers
const showAllAnswersButton = document.getElementById('showAllAnswersButton');
const showCorrectAnswersButton = document.getElementById('showCorrectAnswersButton');
const showWrongAnswersButton = document.getElementById('showWrongAnswersButton');
const showSkippedQuestionsButton = document.getElementById('showSkippedQuestionsButton');
const backToResultsButton = document.getElementById('backToResultsButton'); // Back button
const detailedAnswersTitle = document.getElementById('detailedAnswersTitle');
const questionsList = document.getElementById('questionsList');


// --- নতুন স্প্ল্যাশ স্ক্রিন লজিক ---
window.addEventListener('DOMContentLoaded', (event) => {
    // ২ সেকেন্ড পর স্প্ল্যাশ স্ক্রিন হাইড করুন এবং স্টার্ট স্ক্রিন দেখান
    setTimeout(() => {
        splashScreen.classList.remove('active');
        startScreen.classList.add('active'); // Show the start screen
    }, 2000); // 2 সেকেন্ড (2000 ms)
});
// --- স্প্ল্যাশ স্ক্রিন লজিক শেষ ---


// Set initial info on start screen
totalQuestionsInfo.textContent = questions.length;
fullMarksInfo.textContent = questions.length;
timeLimitInfo.textContent = Math.ceil(questions.length * questionTimeLimit / 60);

// --- Event Listeners ---
// (এই লজিকটি আগের মতোই আছে)
proceedToStartScreenButton.addEventListener('click', validateNameAndStartQuiz);
startButton.addEventListener('click', showNameInputScreen);

nextButton.addEventListener('click', handleNextQuestion);
skipButton.addEventListener('click', handleSkipQuestion);
submitButton.addEventListener('click', handleSubmitQuiz);

// New: Event listeners for the detailed answer buttons
showAllAnswersButton.addEventListener('click', () => displayDetailedQuestions('all'));
showCorrectAnswersButton.addEventListener('click', () => displayDetailedQuestions('correct'));
showWrongAnswersButton.addEventListener('click', () => displayDetailedQuestions('wrong'));
showSkippedQuestionsButton.addEventListener('click', () => displayDetailedQuestions('skipped'));
backToResultsButton.addEventListener('click', backToSummaryScreen);


// Function to shuffle an array (Fisher-Yates algorithm)
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

// --- Name Input and Screen Flow ---
// (এই লজিকটি আগের মতোই আছে)
function validateNameAndStartQuiz() {
    const inputName = userNameInput.value.trim();
    if (inputName === '') {
        nameInputMessage.textContent = "আপনার নাম লিখুন কুইজ শুরু করার জন্য।";
        return;
    }
    userName = inputName; // ব্যবহারকারীর নাম সংরক্ষণ করুন
    nameInputMessage.textContent = ''; // মেসেজ মুছে ফেলুন

    startQuiz();
}

function showNameInputScreen() {
    startScreen.classList.remove('active');
    nameInputScreen.classList.add('active');
}


function startQuiz() { 
    // Shuffle questions at the start of the quiz
    shuffleArray(questions); 
    questions.forEach(q => shuffleArray(q.options)); 

    nameInputScreen.classList.remove('active');
    quizScreen.classList.add('active');
    resetQuizState(); 
    loadQuestion();
    scoreDisplayElem.textContent = score;
}

function resetQuizState() {
    currentQuestionIndex = 0;
    score = 0;
    correctCount = 0;
    wrongCount = 0;
    skippedCount = 0;
    // Reset user answers and status for each question
    questions.forEach(q => {
        q.userAnswer = null;
        q.status = null;
    });
    clearInterval(questionTimerInterval); // নিশ্চিত করুন কোনো টাইমার চলছে না
}


function updateQuestionTimerDisplay() {
    questionTimerTextElem.textContent = questionTimeLeft;

    const offset = circumference - (questionTimeLeft / questionTimeLimit) * circumference;
    progressRingBar.style.strokeDashoffset = offset;

    // Change color based on time left
    if (questionTimeLeft <= 10) {
        progressRingBar.style.stroke = '#FF6347';
    } else if (questionTimeLeft <= 20) {
        progressRingBar.style.stroke = '#FFD700';
    } else {
        progressRingBar.style.stroke = '#28a745';
    }
}

function startQuestionTimer() {
    clearInterval(questionTimerInterval);
    questionTimeLeft = questionTimeLimit;
    updateQuestionTimerDisplay();
    questionTimerInterval = setInterval(() => {
        questionTimeLeft--;
        updateQuestionTimerDisplay();
        if (questionTimeLeft <= 0) {
            clearInterval(questionTimerInterval);
            // Only proceed if the question hasn't been answered yet
            if (questions[currentQuestionIndex].status === null) { // Check status
                handleTimeUp();
            }
        }
    }, 1000);
}


function loadQuestion() {
    if (currentQuestionIndex >= questions.length) {
        handleSubmitQuiz();
        return;
    }
    clearInterval(questionTimerInterval);
    startQuestionTimer();

    const currentQuestion = questions[currentQuestionIndex];
    questionIndexDisplayElem.textContent = `${currentQuestionIndex + 1} / ${questions.length}`;

    // প্রশ্ন এবং অপশনগুলোকে অ্যানিমেশন করার জন্য ক্লাস যুক্ত করা
    questionTextBox.textContent = currentQuestion.question;
    optionsContainer.innerHTML = '';
    
    // Reset and add animation class to question box
    questionTextBox.classList.remove('active');
    void questionTextBox.offsetWidth; // Trigger reflow
    questionTextBox.classList.add('active');

    feedbackMessage.textContent = '';
    feedbackMessage.style.color = 'transparent';
    selectedOption = null;

    nextButton.style.display = 'none';
    skipButton.style.display = 'inline-block';
    submitButton.style.display = 'none';

    if (currentQuestionIndex === questions.length - 1) {
        submitButton.style.display = 'inline-block';
        nextButton.style.display = 'none';
        skipButton.style.display = 'none';
    }

    currentQuestion.options.forEach((option, index) => {
        const button = document.createElement('button');
        button.classList.add('option');
        button.textContent = option;
        button.addEventListener('click', () => selectOption(button, option));
        optionsContainer.appendChild(button);

        // Add staggered animation delay for each option
        setTimeout(() => {
            button.classList.add('active');
        }, index * 100); // 100ms delay for each subsequent option
    });
    enableOptions();
}


function selectOption(selectedButton, selectedAnswer) {
    const currentQuestion = questions[currentQuestionIndex];
    if (currentQuestion.status !== null) return; // Already answered, do nothing

    clearInterval(questionTimerInterval); // Stop the timer as soon as an option is selected

    disableOptions(); // Disable options to prevent multiple clicks

    const correctAnswer = currentQuestion.answer;
    currentQuestion.userAnswer = selectedAnswer; // Store user's answer

    selectedButton.classList.add('selected');

    if (selectedAnswer === correctAnswer) {
        selectedButton.classList.add('correct');
        score += 1;
        correctCount++;
        currentQuestion.status = 'correct'; // Set status
    } else {
        if ("vibrate" in navigator) {
            navigator.vibrate(200); // 200 milliseconds of vibration
        }
        selectedButton.classList.add('wrong');
        wrongCount++;
        
        // Highlight the correct answer if the selected one was wrong
        Array.from(optionsContainer.children).forEach(optionBtn => {
            if (optionBtn.textContent === correctAnswer) {
                optionBtn.classList.add('correct');
            }
        });
        currentQuestion.status = 'wrong'; // Set status
    }

    scoreDisplayElem.textContent = score.toFixed(2);

    // Show appropriate buttons
    nextButton.style.display = 'inline-block';
    skipButton.style.display = 'none';
    submitButton.style.display = (currentQuestionIndex === questions.length - 1) ? 'inline-block' : 'none';
}


function handleTimeUp() {
    const currentQuestion = questions[currentQuestionIndex];
    if (currentQuestion.status !== null) return; // Already answered, do nothing

    skippedCount++;
    currentQuestion.status = 'skipped'; // Set status
    currentQuestion.userAnswer = 'কোনো উত্তর দেওয়া হয়নি'; // Indicate skipped

    showAnswer(); // Show the correct answer
    disableOptions(); // Disable options

    // Automatically move to the next question after a short delay
    setTimeout(() => {
        currentQuestionIndex++;
        loadQuestion();
    }, 2000); // 2 seconds delay
}

function showAnswer() {
    const currentQuestion = questions[currentQuestionIndex];
    const correctAnswer = currentQuestion.answer;

    Array.from(optionsContainer.children).forEach(optionBtn => {
        optionBtn.style.pointerEvents = 'none'; // Ensure no further clicks
        if (optionBtn.textContent === correctAnswer) {
            optionBtn.classList.add('correct'); // Highlight correct answer
        }
    });

    // Ensure buttons are correctly displayed after showing answer
    nextButton.style.display = 'inline-block';
    skipButton.style.display = 'none';
    submitButton.style.display = (currentQuestionIndex === questions.length - 1) ? 'inline-block' : 'none';
}


function disableOptions() {
    Array.from(optionsContainer.children).forEach(opt => {
        opt.style.pointerEvents = 'none';
    });
}

function enableOptions() {
    Array.from(optionsContainer.children).forEach(opt => {
        opt.style.pointerEvents = 'auto';
        opt.classList.remove('selected', 'correct', 'wrong');
    });
}


function handleNextQuestion() {
    const currentQuestion = questions[currentQuestionIndex];
    // If user clicks Next without selecting an option, treat as skipped
    if (currentQuestion.status === null) {
        clearInterval(questionTimerInterval); // Stop timer
        skippedCount++;
        currentQuestion.status = 'skipped';
        currentQuestion.userAnswer = 'কোনো উত্তর দেওয়া হয়নি';
        showAnswer(); // Show answer for skipped question
        disableOptions(); // Disable options
        // Wait briefly before moving to next question for skipped questions
        setTimeout(() => {
            currentQuestionIndex++;
            loadQuestion();
        }, 1000); // Shorter delay for manual skip
    } else {
        // If already answered, just move to next
        currentQuestionIndex++;
        loadQuestion();
    }
}

function handleSkipQuestion() {
    const currentQuestion = questions[currentQuestionIndex];
    if (currentQuestion.status !== null) return; // Already answered, do nothing

    clearInterval(questionTimerInterval);
    skippedCount++;
    currentQuestion.status = 'skipped';
    currentQuestion.userAnswer = 'কোনো উত্তর দেওয়া হয়নি';

    showAnswer();
    disableOptions();

    setTimeout(() => {
        currentQuestionIndex++;
        loadQuestion();
    }, 1000); // Shorter delay for manual skip
}


function handleSubmitQuiz() {
    clearInterval(questionTimerInterval); // Stop any running timer
    quizScreen.classList.remove('active');
    resultScreen.classList.add('active'); // Show the main result screen first

    // Ensure detailed answers container is hidden initially
    detailedAnswersContainer.style.display = 'none';
    resultSummary.style.display = 'block'; // Show result summary

    const totalPossibleScore = questions.length;
    const yourPercentage = (score / totalPossibleScore) * 100;

    document.getElementById('finalTotalQuestions').textContent = questions.length;
    document.getElementById('correctAnswers').textContent = correctCount;
    document.getElementById('wrongAnswers').textContent = wrongCount;
    document.getElementById('skippedQuestions').textContent = skippedCount;
    document.getElementById('finalScore').textContent = score.toFixed(2);
    document.getElementById('yourPercentage').textContent = yourPercentage.toFixed(2) + '%';

    // Set percentage bar width
    const percentageBarFill = document.getElementById('percentageBarFill');
    percentageBarFill.style.width = `${yourPercentage}%`;
    if (yourPercentage >= 50) { 
        percentageBarFill.style.backgroundColor = '#28a745'; // Green
    } else {
        percentageBarFill.style.backgroundColor = '#dc3545'; // Red
    }

    // Firebase-এ ফলাফল সেভ করুন এবং র‍্যাঙ্কিং লোড করুন
    saveQuizResult();
    displayRankings();
}

// Firebase-এ ফলাফল সেভ করুন
function saveQuizResult() {
    if (!userName) {
        console.error("ব্যবহারকারীর নাম পাওয়া যায়নি। ফলাফল সেভ করা যাবে না।");
        alert("আপনার নাম ছাড়া ফলাফল সেভ করা যাবে না।");
        return;
    }

    database.ref('quizResults/' + QUIZ_ID).push({
        name: userName, 
        score: score.toFixed(2), 
        correct: correctCount,
        wrong: wrongCount,
        skipped: skippedCount,
        totalQuestions: questions.length,
        timestamp: new Date().toISOString()
    })
    .then(() => {
        console.log("ফলাফল সফলভাবে Firebase-এ সেভ হয়েছে!");
    })
    .catch((error) => {
        console.error("ফলাফল সেভ করতে সমস্যা হয়েছে:", error);
        alert("ফলাফল সেভ করতে সমস্যা হয়েছে।");
    });
}

// Firebase থেকে র‍্যাঙ্কিং লোড এবং প্রদর্শন করুন
function displayRankings() {
    rankListElem.innerHTML = '<li>র‍্যাঙ্কিং লোড হচ্ছে...</li>';

    database.ref('quizResults/' + QUIZ_ID).once('value', (snapshot) => {
        const userHighestScores = {}; 

        snapshot.forEach((childSnapshot) => {
            const data = childSnapshot.val();
            if (!data.name || typeof data.name !== 'string' || data.name.trim() === '') {
                return; 
            }
            const userScore = parseFloat(data.score);
            if (isNaN(userScore)) {
                return;
            }

            const userName = data.name;

            if (!userHighestScores[userName] || userScore > userHighestScores[userName].score) {
                userHighestScores[userName] = {
                    name: userName,
                    score: userScore
                };
            }
        });

        const rankings = Object.values(userHighestScores);

        rankings.sort((a, b) => b.score - a.score);

        rankListElem.innerHTML = '';
        if (rankings.length === 0) {
            rankListElem.innerHTML = '<li>এখনো কোনো র‍্যাঙ্কিং নেই।</li>';
        } else {
            rankings.forEach((entry, index) => {
                const listItem = document.createElement('li');
                listItem.textContent = `${index + 1}. ${entry.name} - স্কোর: ${entry.score.toFixed(2)}`;
                rankListElem.appendChild(listItem);
            });
        }
    })
    .catch((error) => {
        console.error("র‍্যাঙ্কিং লোড করতে সমস্যা হয়েছে:", error);
        rankListElem.innerHTML = '<li>র‍্যাঙ্কিং লোড করা যায়নি।</li>';
    });
}

// Function to display detailed answers based on category
function displayDetailedQuestions(category) {
    resultSummary.style.display = 'none'; // Hide summary
    detailedAnswersContainer.style.display = 'block'; // Show detailed view
    questionsList.innerHTML = ''; // Clear previous list

    let titleText = '';
    let filteredQuestions = [];

    if (category === 'all') {
        titleText = 'সমস্ত প্রশ্ন ও উত্তর';
        filteredQuestions = questions;
    } else if (category === 'correct') {
        titleText = 'সঠিক উত্তরসমূহ';
        filteredQuestions = questions.filter(q => q.status === 'correct');
    } else if (category === 'wrong') {
        titleText = 'ভুল উত্তরসমূহ';
        filteredQuestions = questions.filter(q => q.status === 'wrong');
    } else if (category === 'skipped') {
        titleText = 'বাদ পড়া প্রশ্নসমূহ';
        filteredQuestions = questions.filter(q => q.status === 'skipped');
    }

    detailedAnswersTitle.textContent = titleText;

    if (filteredQuestions.length === 0) {
        const listItem = document.createElement('li');
        listItem.textContent = `এই ক্যাটাগরিতে কোনো প্রশ্ন নেই।`;
        questionsList.appendChild(listItem);
        return;
    }

    filteredQuestions.forEach((q, index) => {
        const listItem = document.createElement('li');
        listItem.classList.add('detailed-question-item'); 

        let statusText = '';
        let statusClass = '';

        if (q.status === 'correct') {
            statusText = ' (Correct)';
            statusClass = 'correct-status';
        } else if (q.status === 'wrong') {
            statusText = ' (Wrong)';
            statusClass = 'wrong-status';
        } else if (q.status === 'skipped') {
            statusText = ' (Skipped)';
            statusClass = 'skipped-status';
        }

        const originalQuestionIndex = questions.indexOf(q); 
        const questionNumber = originalQuestionIndex + 1; 

        let questionHtml = `
            <div class="question-header">
                <span class="question-number">${questionNumber}.</span>
                <span class="question-text">${q.question}</span>
                <span class="status-indicator ${statusClass}">${statusText}</span>
            </div>
            <ul class="detailed-options">
        `;

        q.options.forEach(option => {
            let optionClass = '';
            if (q.userAnswer === option) {
                if (q.status === 'correct') {
                    optionClass = 'selected-correct';
                } else if (q.status === 'wrong') {
                    optionClass = 'selected-wrong';
                }
            }
            if (option === q.answer && q.status !== 'correct') { 
                optionClass += ' correct-answer-highlight';
            }
            
            questionHtml += `<li class="${optionClass}">${option}</li>`;
        });

        questionHtml += `</ul>`;
        listItem.innerHTML = questionHtml;
        questionsList.appendChild(listItem);
    });
}


// Function to go back to result summary
function backToSummaryScreen() {
    detailedAnswersContainer.style.display = 'none'; // Hide detailed view
    resultSummary.style.display = 'block'; // Show summary
}
